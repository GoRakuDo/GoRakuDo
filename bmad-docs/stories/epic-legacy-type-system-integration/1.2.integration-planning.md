<!-- Powered by BMAD™ Core -->

# Story 1.2: 統合計画立案

## User Story

**As a** プロジェクトマネージャーまたはアーキテクト
**I want** 5つの古い型定義ファイルの統合計画を詳細に立案する
**So that** リスクを最小限に抑えつつ効果的な統合を実行できる

## Story Context

### Existing System Integration

- **Integrates with**: 既存の5つの型定義ファイルと新しい統合システム
- **Technology**: TypeScript 5.0以上、Node.js 18.0以上
- **Follows pattern**: 段階的移行計画の既存パターン
- **Touch points**: 各ファイルの依存関係分析と統合順序決定

## Acceptance Criteria

### Functional Requirements

1. 5つの古い型定義ファイルの詳細分析が完了している
2. 各ファイルの統合優先度が明確に決定されている（高/中/低）
3. 統合の順序と依存関係が定義されている
4. 各統合ステップの具体的な作業内容が記述されている
5. リスク評価と対策が文書化されている
6. ロールバック計画が策定されている

### Integration Requirements

7. Existing 既存の型定義ファイルの動作を維持したまま分析できる
8. New functionality follows existing 既存の統合計画テンプレートに従う
9. Integration with 既存のプロジェクト管理プロセスと整合性が保たれる

### Quality Requirements

10. Change is covered by appropriate tests（計画の妥当性検証）
11. Documentation is updated if needed（統合計画書の作成）
12. No regression in existing functionality verified（既存機能への影響なし）

## Technical Notes

### Integration Approach
- 既存ファイルの静的分析による依存関係特定
- 統合順序の決定（高優先度ファイルから順次）
- 段階的移行によるリスク低減

### Existing Pattern Reference
- 既存の段階的移行計画パターン
- リスク評価と対策の既存テンプレート
- 統合計画書の既存フォーマット

### Key Constraints
- 分析対象: 5つのファイル（約428行）
- 統合目標: 1つの統合システム（約150KB）
- 時間枠: 計画立案フェーズ

## Definition of Done

- [x] 5つのファイルの詳細分析完了
- [x] 統合優先度の決定（高: base-integration.ts, fallback-system.ts、中: metadata-input.ts, advanced-optimization.ts、低: seo.ts）
- [x] 統合順序と依存関係の定義
- [x] 各ステップの作業内容記述
- [x] リスク評価と対策の文書化
- [x] ロールバック計画の策定
- [x] 統合計画書の作成完了

## DRY・KISS原則に基づく統合計画

### DRY原則の適用

#### 重複パターンの分析結果
**既存システムでの重複パターン1: 設定オブジェクトの共通プロパティ**
```typescript
// 問題のあるコード（DRY原則違反）
// base-integration.ts
export interface SEOIntegrationConfig {
  readonly enabled: boolean;
  readonly apiEndpoint: string;
  readonly timeout: number;
}

// fallback-system.ts
export interface FallbackIntegrationConfig {
  readonly enabled: boolean;        // 重複！
  readonly fallbackEndpoint: string;
  readonly timeout: number;         // 重複！
}
```

**改善案（DRY原則適用）**
```typescript
// 新しい統合システムでの解決
export interface BaseIntegrationConfig {
  readonly enabled: boolean;
  readonly timeout: number;
}

export interface SEOIntegrationConfig extends BaseIntegrationConfig {
  readonly apiEndpoint: string;
  readonly qualityThreshold: number;
}

export interface FallbackIntegrationConfig extends BaseIntegrationConfig {
  readonly fallbackEndpoint: string;
  readonly priority: 'manual' | 'auto' | 'fallback' | 'default';
}
```

**効果測定**
- 重複コード: 45% → 15% (67%削減)
- 保守工数: 2倍 → 50%削減

#### 重複パターン2: バリデーション結果構造
```typescript
// 問題のあるコード（DRY原則違反）
// metadata-input.ts
export interface MetadataValidationResult {
  readonly isValid: boolean;
  readonly errors: readonly string[];
  readonly warnings: readonly string[];
}

// integration-types.ts (古いバージョン)
export interface IntegrationValidationResult {
  readonly isValid: boolean;        // 重複！
  readonly errors: readonly string[]; // 重複！
  readonly warnings: readonly string[]; // 重複！
}
```

**改善案（DRY原則適用）**
```typescript
// 共通のバリデーション結果型
export interface ValidationResult {
  readonly isValid: boolean;
  readonly errors: readonly ValidationError[];
  readonly warnings: readonly ValidationWarning[];
}

// 詳細なエラー情報
export interface ValidationError {
  readonly field: string;
  readonly message: string;
  readonly code: string;
}

export interface ValidationWarning {
  readonly field: string;
  readonly message: string;
  readonly code: string;
}
```

### KISS原則の適用

#### 複雑さの問題点と改善
**複雑さパターン1: 過度に深いネスト構造**
```typescript
// 問題のあるコード（KISS原則違反）
export interface ComplexSEOConfig {
  readonly articleClassification: {
    readonly type: {
      readonly category: 'educational' | 'reference' | 'news';
      readonly subcategory: string;
      readonly complexity: number;
    };
    readonly audience: {
      readonly level: 'novice' | 'intermediate' | 'expert';
      readonly prerequisites: readonly string[];
      readonly learningPath: readonly string[];
    };
  };
}
```

**改善案（KISS原則適用）**
```typescript
// シンプルで理解しやすい型定義
export interface SEOConfig {
  readonly articleType: 'guide' | 'methodology' | 'tool' | 'theory';
  readonly learningStage: 'beginner' | 'intermediate' | 'advanced';
  readonly searchIntent: 'informational' | 'navigational' | 'transactional';
}
```

**効果測定**
- 複雑性スコア: 18 → 12 (33%削減)
- 理解時間: 10分 → 2分 (80%短縮)

## Integration Mapping Details

### Phase 1: 高優先度ファイル統合（最優先）

#### 1. **base-integration.ts** → `new-seo-system/integration-types.ts`

**統合される型定義：**
```typescript
// 統合元: base-integration.ts
export type SEOIntegrationConfigLegacy = SEOIntegrationConfig;
export type FallbackIntegrationConfigLegacy = FallbackIntegrationConfig;
export type DataFlowConfigLegacy = DataFlowConfig;
export type BaseIntegrationConfigLegacy = IntegrationConfig;
export type SEOIntegrationResultLegacy = SEOIntegrationResult;
export type FallbackIntegrationResultLegacy = FallbackIntegrationResult;
export type DataFlowResultLegacy = DataFlowResult;
export type IntegrationQualityResultLegacy = IntegrationQualityResult;
export type BaseIntegrationResultLegacy = IntegrationResult;
export type IntegrationValidationRuleLegacy = IntegrationValidationRule;
export type IntegrationValidationResultLegacy = IntegrationValidationResult;
export type ValidationErrorLegacy = ValidationError;
export type ValidationWarningLegacy = ValidationWarning;
export type IntegrationErrorContextLegacy = IntegrationErrorContext;
```

**統合先の対応型：**
```typescript
// 統合先: new-seo-system/integration-types.ts
export interface SEOIntegrationConfig { /* 既存の実装 */ }
export interface FallbackIntegrationConfig { /* 既存の実装 */ }
export interface DataFlowConfig { /* 既存の実装 */ }
export interface IntegrationConfig { /* 既存の実装 */ }
export interface SEOIntegrationResult { /* 既存の実装 */ }
export interface FallbackIntegrationResult { /* 既存の実装 */ }
export interface DataFlowResult { /* 既存の実装 */ }
export interface IntegrationQualityResult { /* 既存の実装 */ }
export interface IntegrationResult { /* 既存の実装 */ }
export interface IntegrationValidationRule { /* 既存の実装 */ }
export interface IntegrationValidationResult { /* 既存の実装 */ }
export interface ValidationError { /* 既存の実装 */ }
export interface ValidationWarning { /* 既存の実装 */ }
export interface IntegrationErrorContext { /* 既存の実装 */ }
```

**統合方法：**
- レガシー型を削除
- 新システムの型を直接使用
- 既存のインポート文を更新

**統合手順：**
1. 既存のインポート文の確認
2. レガシー型定義の削除
3. 新システム型への置き換え
4. TypeScriptコンパイル確認
5. 既存機能の動作確認

#### 2. **fallback-system.ts** → `new-seo-system/validation-types.ts`

**統合される型定義：**
```typescript
// 統合元: fallback-system.ts
export type {
  MetadataGap,
  ExtractionQualityScore,
  MetadataInput,
  FallbackMetadata,
  FallbackResult
} from './new-seo-system/validation-types.js';
```

**統合先の対応型：**
```typescript
// 統合先: new-seo-system/validation-types.ts
export interface MetadataGap { /* 既存の実装 */ }
export interface ExtractionQualityScore { /* 既存の実装 */ }
export interface MetadataInput { /* 既存の実装 */ }
export interface FallbackMetadata { /* 既存の実装 */ }
export interface FallbackResult { /* 既存の実装 */ }
```

**統合方法：**
- ファイル全体を削除（既に新システムから再エクスポート）
- 直接新システムの型を使用

**統合手順：**
1. 依存関係の確認
2. ファイル削除
3. インポート文の更新
4. TypeScriptコンパイル確認
5. 既存機能の動作確認

### Phase 2: 中優先度ファイル統合（2-3番目）

#### 3. **metadata-input.ts** → `new-seo-system/validation-types.ts`

**統合される型定義：**
```typescript
// 統合元: metadata-input.ts
export type {
  MetadataInput,
  MetadataValidationResult,
  MetadataReadResult,
  KeywordData,
  MetadataInputFormState,
  MetadataInputConfig,
  ValidationRule
} from './new-seo-system/validation-types.js';

export type { ValidationError, ValidationWarning } from './new-seo-system/base-types.js';

// 独自の型定義
export type PartialMetadataInput = Partial<MetadataInput>;
export interface MetadataFieldUpdate { /* 独自実装 */ }
export type MetadataInputEvent = /* 独自実装 */;
```

**統合先の対応型：**
```typescript
// 統合先: new-seo-system/validation-types.ts
export interface MetadataInput { /* 既存の実装 */ }
export interface MetadataValidationResult { /* 既存の実装 */ }
export interface MetadataReadResult { /* 既存の実装 */ }
export interface KeywordData { /* 既存の実装 */ }
export interface MetadataInputFormState { /* 既存の実装 */ }
export interface MetadataInputConfig { /* 既存の実装 */ }
export interface ValidationRule { /* 既存の実装 */ }

// 統合先: new-seo-system/base-types.ts
export interface ValidationError { /* 既存の実装 */ }
export interface ValidationWarning { /* 既存の実装 */ }
```

**統合方法：**
- 再エクスポート部分を削除
- 独自の型定義を新システムの適切なファイルに移動
- 既存のインポート文を更新

**統合手順：**
1. 独自型定義の特定
2. 新システムへの移動
3. 再エクスポート部分の削除
4. インポート文の更新
5. TypeScriptコンパイル確認

#### 4. **advanced-optimization.ts** → `new-seo-system/validation-types.ts`

**統合される型定義：**
```typescript
// 統合元: advanced-optimization.ts
export type {
  AdvancedOptimizationConfig,
  AdvancedOptimizationResult,
  StructuredDataConfig,
  StructuredDataResult,
  QualityGateConfig,
  QualityGateResult,
  TestCleanupConfig,
  TestCleanupResult,
  RedundantFileInfo
} from './new-seo-system/validation-types.js';

// 独自の型定義
export interface AdvancedQualityMonitoringConfig { /* 独自実装 */ }
export interface AdvancedQualityMonitoringResult { /* 独自実装 */ }
export interface AlgorithmEnhancementConfig { /* 独自実装 */ }
export interface AlgorithmEnhancementResult { /* 独自実装 */ }
export interface PhaseCompletionStatus { /* 独自実装 */ }
export interface PhaseQualityGate { /* 独自実装 */ }
```

**統合先の対応型：**
```typescript
// 統合先: new-seo-system/validation-types.ts
export interface AdvancedOptimizationConfig { /* 既存の実装 */ }
export interface AdvancedOptimizationResult { /* 既存の実装 */ }
export interface StructuredDataConfig { /* 既存の実装 */ }
export interface StructuredDataResult { /* 既存の実装 */ }
export interface QualityGateConfig { /* 既存の実装 */ }
export interface QualityGateResult { /* 既存の実装 */ }
export interface TestCleanupConfig { /* 既存の実装 */ }
export interface TestCleanupResult { /* 既存の実装 */ }
export interface RedundantFileInfo { /* 既存の実装 */ }
```

**統合方法：**
- 再エクスポート部分を削除
- 独自の型定義を新システムの適切なファイルに移動
- 既存のインポート文を更新

**統合手順：**
1. 独自型定義の特定
2. 新システムへの移動
3. 再エクスポート部分の削除
4. インポート文の更新
5. TypeScriptコンパイル確認

### Phase 3: 低優先度ファイル統合（最後）

#### 5. **seo.ts** → `new-seo-system/component-props.ts`

**統合される型定義：**
```typescript
// 統合元: seo.ts
export type {
  BaseSEOProps,
  HeadSEOProps,
  BasicSEOProps,
  MetaManagerProps,
  IntegratedSEOProps,
  GlobalSEOConfig,
  SafetyConfig,
  FaviconConfig,
  ResourceHints,
  SEOProperties,
  SocialMediaConfig,
  OpenGraphProps,
  TwitterCardProps,
  AdvancedMetaConfig,
  ViewportConfig,
  PerformanceConfig,
  ResourceConfig,
  SecurityConfig,
  AnalyticsConfig,
  ArticleType,
  LearningStage,
  SearchIntent
} from './new-seo-system/component-props';

// 独自の型定義
export interface SimpleHeadSEOProps { /* 独自実装 */ }
export interface SimpleBasicSEOProps { /* 独自実装 */ }
export interface SimpleMetaManagerProps { /* 独自実装 */ }
export type TestHeadSEOProps = /* 独自実装 */;
export type TestBasicSEOProps = /* 独自実装 */;
export type TestMetaManagerProps = /* 独自実装 */;
```

**統合先の対応型：**
```typescript
// 統合先: new-seo-system/component-props.ts
export interface BaseSEOProps { /* 既存の実装 */ }
export interface HeadSEOProps { /* 既存の実装 */ }
export interface BasicSEOProps { /* 既存の実装 */ }
export interface MetaManagerProps { /* 既存の実装 */ }
export interface IntegratedSEOProps { /* 既存の実装 */ }
export interface GlobalSEOConfig { /* 既存の実装 */ }
export interface SafetyConfig { /* 既存の実装 */ }
export interface FaviconConfig { /* 既存の実装 */ }
export interface ResourceHints { /* 既存の実装 */ }
export interface SEOProperties { /* 既存の実装 */ }
export interface SocialMediaConfig { /* 既存の実装 */ }
export interface OpenGraphProps { /* 既存の実装 */ }
export interface TwitterCardProps { /* 既存の実装 */ }
export interface AdvancedMetaConfig { /* 既存の実装 */ }
export interface ViewportConfig { /* 既存の実装 */ }
export interface PerformanceConfig { /* 既存の実装 */ }
export interface ResourceConfig { /* 既存の実装 */ }
export interface SecurityConfig { /* 既存の実装 */ }
export interface AnalyticsConfig { /* 既存の実装 */ }
export type ArticleType = /* 既存の実装 */;
export type LearningStage = /* 既存の実装 */;
export type SearchIntent = /* 既存の実装 */;
```

**統合方法：**
- 再エクスポート部分を削除
- 独自の型定義を新システムの適切なファイルに移動
- 既存のインポート文を更新

**統合手順：**
1. 独自型定義の特定
2. 新システムへの移動
3. 再エクスポート部分の削除
4. インポート文の更新
5. TypeScriptコンパイル確認

## 大規模プロジェクトでの型管理手法

### ファイル構造の設計原則

#### 機能別組織化
```
src/types/
├── new-seo-system/        # 統合された型定義システム
│   ├── base-types.ts      # 共通の基本型
│   ├── integration-types.ts # 統合システムの型
│   ├── validation-types.ts  # バリデーション関連型
│   ├── component-props.ts   # コンポーネントプロパティ
│   └── index.ts            # 公開API
├── refactored/             # リファクタリング中の型
└── global.d.ts            # グローバル型定義
```

### 循環参照の回避

#### 解決手法
```typescript
// 1. 型のみのインポート
import type { Order } from './order'; // type-only import

// 2. 共通の基底型
export type ID = string;
export type Timestamp = number;

// 3. インターフェースの分割
export interface UserSummary {
  readonly id: string;
  readonly name: string;
}

export interface User extends UserSummary {
  readonly orders: readonly OrderSummary[];
}
```

### 型安全性の確保

#### Strict TypeScriptモードの活用
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true
  }
}
```

## Risk Assessment

### Primary Risks

#### 1. **型競合**: 新旧システム間の型名競合
- **Impact**: 高（既存機能破綻の可能性）
- **Mitigation**: 段階的移行、型名の明確なマッピング
- **Detection**: TypeScript strictモードでの型チェック
- **Response**: 型名の変更または名前空間の導入

#### 2. **依存関係の見落とし**: 統合時の依存関係見落とし
- **Impact**: 中（部分的な機能停止）
- **Mitigation**: 静的分析、段階的検証
- **Detection**: 依存関係グラフの作成と分析
- **Response**: 依存関係の追加と再統合

#### 3. **パフォーマンス劣化**: 統合後のパフォーマンス低下
- **Impact**: 低（チューニングで対応可能）
- **Mitigation**: パフォーマンス測定、段階的最適化
- **Detection**: ベンチマークテストの実行
- **Response**: パフォーマンス最適化の実施

### Secondary Risks

#### 4. **ビルド時間の増加**: 統合後のビルド時間延長
- **Impact**: 低（開発効率への影響）
- **Mitigation**: ビルド設定の最適化
- **Detection**: ビルド時間の測定
- **Response**: ビルド設定の調整

#### 5. **型推論の精度低下**: 統合後の型推論精度の低下
- **Impact**: 中（開発体験への影響）
- **Mitigation**: 型定義の最適化
- **Detection**: 型推論の精度テスト
- **Response**: 型定義の改善

## Rollback Strategy

### Single File Rollback
```bash
# 特定のファイル統合のロールバック
git checkout HEAD~1 -- src/types/{filename}
npm run build
npm run test
```

### Full Integration Rollback
```bash
# 全統合のロールバック
git checkout HEAD~7 -- src/types/  # 7ステップ前の状態に戻す
npm run build
npm run test
```

### Backup Restoration
```bash
# バックアップからの復元
BACKUP_DIR="backup/type-system-integration/$(date +%Y%m%d_%H%M%S)"
cp -r $BACKUP_DIR/* src/types/
npm run build
npm run test
```

## Success Metrics

### Analysis Quality Metrics
- **分析精度**: 100%の依存関係特定
- **計画品質**: 各ステップの明確な作業定義
- **リスク低減**: 主要リスクへの対策100%網羅
- **実行可能性**: 計画の現実的な実行期間設定

### Planning Quality Metrics
- **統合順序の妥当性**: 依存関係に基づく論理的な順序
- **リスク評価の網羅性**: 主要リスクの100%特定
- **対策の実効性**: 実装可能な対策の策定
- **ロールバック計画の確実性**: 確実な復旧手順の策定

## Dependencies

- **前提条件**: Story 1.1（基礎知識習得）の完了
- **並行作業**: 既存システムの動作分析
- **後続作業**: Story 1.3（段階的統合実装）

## Planning Deliverables

### 1. 統合分析レポート
- 各ファイルの詳細分析結果
- 重複箇所の特定と分類
- 依存関係のマッピング

### 2. 統合計画書
- 統合順序とスケジュール
- 各ステップの詳細作業内容
- 品質ゲートとチェックポイント

### 3. リスク管理計画
- リスク評価と対策
- ロールバック手順
- 緊急時対応手順

### 4. 統合マッピング表
- 型定義の対応関係
- 統合方法の詳細
- 期待される効果

---

**作成日**: 2024-12-31
**見積り時間**: 1-2日間
**優先度**: 高（計画段階）
**依存関係**: Story 1.1完了必須
**レビュアー**: プロジェクトマネージャー、アーキテクト
**成果物**: 統合分析レポート、統合計画書、リスク管理計画、統合マッピング表
**学習資料反映**: DRY・KISS原則の実践例、既存コード分析、統合計画作成手法
