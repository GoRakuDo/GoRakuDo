---
import { CldImage } from 'astro-cloudinary';

// Interface for Historical Figure Data
interface HistoricalFigure {
  id: string;
  name: string;
  year: string;
  quote: string;
  source: string;
  avatarId: string;
  color: string; // Tailwind color class for accents
}

const historyData: HistoricalFigure[] = [
  {
    id: 'augustine',
    name: 'St. Augustine',
    year: '430 AD',
    quote: 'Waktu itu juga (ketika masih bayi) aku tidak tahu bahasa Latin; tetapi aku mempelajarinya tanpa rasa takut atau penderitaan, hanya dengan pengamatan, di tengah-tengah kasih sayang dari pengasuhku dan canda tawa teman-temanku... Aku mempelajari kata-kata bukan dari mereka yang mengajar, tetapi dari mereka yang berbicara denganku.',
    source: 'Confessions (Book I, Chapter 14)',
    avatarId: 'Saint_Augustine_Profile_touewn',
    color: 'text-amber-400',
  },
  {
    id: 'dante',
    name: 'Dante Alighieri',
    year: '1321',
    quote: 'Saya menyatakan bahwa bahasa sehari-hari adalah bahasa yang kita pelajari tanpa instruksi formal, dengan meniru pengasuh kita... [bahasa] ini alami bagi kita, sementara tata bahasa lainnya, sebaliknya, bersifat buatan.',
    source: 'De Vulgari Eloquentia (Book I, Chapter I)',
    avatarId: 'Dante_Alighieri_Profile_tneto0',
    color: 'text-rose-400',
  },
  {
    id: 'ibn_khaldun',
    name: 'Ibn Khaldun',
    year: '1406',
    quote: 'Itu karena bahasa Arab hanya dapat dikuasai melalui pengulangan ucapan dan latihan terus-menerus sesuai dengan cara orang Arab, sehingga hasilnya adalah terbentuknya kemampuan dalam organ-organ bicara... [Hal itu] tidak diperoleh melalui pemahaman aturan tata bahasa.',
    source: 'The Muqaddimah (Chapter 6, Section on the Science of Grammar)',
    avatarId: 'Ibn_Khaldun_Profile_b1cprg',
    color: 'text-emerald-400',
  },
  {
    id: 'montaigne',
    name: 'Michel de Montaigne',
    year: '1592',
    quote: 'Tanpa seni, tanpa buku, tanpa tata bahasa, tanpa aturan, tanpa cambuk, dan tanpa air mata, aku telah mempelajari Latin semurni yang diketahui oleh guru sekolahku.',
    source: 'On Educating Children (Book I, Chapter 26)',
    avatarId: 'Michel_de_Montaigne_Profile_mnwdhp',
    color: 'text-blue-400',
  },
  {
    id: 'erasmus',
    name: 'Desiderius Erasmus',
    year: '1536',
    quote: 'Saya tidak sabar dengan kebodohan guru tata bahasa pada umumnya yang membuang-buang tahun berharga dengan menghantamkan aturan-aturan ke dalam kepala anak-anak. Sebab, kita tidak memperoleh kemampuan berbicara bahasa dengan mempelajari aturan-aturan, melainkan melalui interaksi sehari-hari dengan orang-orang yang terbiasa mengekspresikan diri dengan ketepatan dan kemahiran.',
    source: 'De Ratione Studii',
    avatarId: 'Desiderius_Erasmus_Profile_g00gu9',
    color: 'text-purple-400',
  },
];

const biomeImageId = 'Immersion_History_Biome_Generated_Image_1rv8oq1rv8oq1rv8_vrbuai';
---

<div class="history-biome-wrapper w-full max-w-5xl mx-auto">
  <!-- 1. Main Biome Display -->
  <div class="relative w-full h-auto group mb-8 flex justify-center px-4 sm:px-8 md:px-0">
    <!-- Background Image -->
    <CldImage
      src={biomeImageId}
      alt="Historical Biome Landscape"
      width={1920}
      height={1080}
      quality="auto"
      format="auto"
      class="block w-full h-auto drop-shadow-2xl"
    />
  </div>

  <!-- 2. Avatar Selection Row (Grid/Flex) -->
  <div class="relative pt-4 pb-8 mb-4">
    <!-- Connecting Line -->
    <!-- Aligned to center of avatars (squarcle): 
         Mobile: Parent pt-4 (1rem) + Flex py-4 (1rem) + Half h-16 (2rem) = 4rem (top-16)
         Desktop: Parent pt-4 (1rem) + Flex py-4 (1rem) + Half h-20 (2.5rem) = 4.5rem (top-[4.5rem])
    -->
    <div class="absolute md:top-18 top-16 left-12 right-12 md:left-22 md:right-22 h-0.5 bg-white/10 rounded-full hidden md:block z-0"></div>

    <div class="relative flex flex-wrap md:flex-nowrap justify-center md:justify-between gap-4 md:gap-4 md:overflow-x-auto py-4 px-4 md:px-12 no-scrollbar md:snap-x z-10">
      {historyData.map((figure, index) => (
        <button
          class="history-avatar-btn group relative flex flex-col items-center gap-4 shrink-0 snap-center focus:outline-none"
          data-index={index}
          aria-label={`View message from ${figure.name}`}
        >
          <!-- Avatar Squarcle -->
          <div class="relative w-16 h-16 md:w-20 md:h-20 rounded-2xl shadow-lg transition-all duration-300 transform group-hover:scale-110 group-focus-visible:ring-2 ring-(--token-purple-base) overflow-hidden z-20 bg-gray-800">
             <div class="absolute inset-0 bg-black/50 group-hover:bg-transparent transition-colors duration-300 overlay-dim"></div>
             <CldImage
                src={figure.avatarId}
                alt={figure.name}
                width={100}
                height={100}
                crop="thumb"
                gravity="face"
                class="w-full h-full object-cover"
             />
             <!-- Active Ring (Hidden by default) -->
             <div class="active-ring absolute inset-0 border-4 border-transparent transition-colors duration-300 rounded-2xl"></div>
          </div>

          <!-- Label (Name & Year) -->
          <div class="text-center opacity-60 group-hover:opacity-100 transition-opacity duration-300 max-w-[120px]">
            <span class={`block text-xs md:text-sm font-bold ${figure.color}`}>{figure.year}</span>
            <span class="block text-[10px] md:text-xs uppercase tracking-wide text-white/80 leading-tight">{figure.name}</span>
          </div>
        </button>
      ))}
    </div>
  </div>

  <!-- 3. Message Card (Below Avatars) -->
  <div class="w-full flex justify-center px-4 md:px-0">
      <!-- The Message Card -->
      <div 
        id="history-message-card" 
        class="bg-(--token-bg-light)/10 backdrop-blur-md border border-white/10 p-4 sm:p-6 md:p-8 lg:p-10 rounded-2xl md:rounded-3xl w-full md:max-w-4xl min-h-[400px] sm:min-h-[350px] md:min-h-[280px] transform transition-all duration-500 translate-y-4 opacity-0 scale-95 shadow-2xl relative overflow-hidden"
      >
        <!-- Background Decor -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-linear-to-br from-white/5 to-transparent rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

        <!-- Header: Avatar + Name + Year -->
        <div class="flex items-center gap-3 sm:gap-4 md:gap-6 mb-4 sm:mb-5 md:mb-6 border-b border-white/5 pb-4 sm:pb-5 md:pb-6 relative z-10">
           <!-- Dynamic Avatar in Header -->
           <div class="w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 rounded-xl sm:rounded-2xl overflow-hidden border-2 border-white/10 shrink-0 relative bg-black/20 shadow-inner">
              <img id="card-avatar-img" src="" alt="" class="w-full h-full object-cover" />
           </div>
           <div class="text-left">
                           <h4 id="card-name" class="font-bold text-white text-sm sm:text-base md:text-xl uppercase tracking-tight"></h4>
             <span id="card-year" class="text-sm font-mono text-(--token-text-muted) tracking-wider"></span>
           </div>
        </div>

        <!-- Quote Body -->
        <div class="relative z-10">
          <span class="absolute -top-4 -left-2 text-6xl text-white/5 font-serif">â€œ</span>
          <p id="card-quote" class="text-base md:text-xl text-(--token-text-primary) text-left leading-relaxed italic mb-6 relative pl-2">
             <!-- Quote goes here -->
          </p>
        </div>

        <!-- Source Footer -->
        <div class="text-right relative z-10 border-t border-white/5 pt-4">
           <p id="card-source" class="text-xs text-(--token-text-muted) font-bold uppercase tracking-widest opacity-80"></p>
        </div>
      </div>
  </div>
</div>

<script>
  // Client-side logic for the interactive biome
  // Define the data interface locally for the script
  type FigureData = {
    name: string;
    year: string;
    quote: string;
    source: string;
    avatarUrl: string; // We'll grab this from the DOM for simplicity or reconstructing URL
    colorClass: string;
  };

  function initHistoryBiome() {
    const wrapper = document.querySelector('.history-biome-wrapper');
    if (!wrapper) return;

    const btns = wrapper.querySelectorAll('.history-avatar-btn') as NodeListOf<HTMLButtonElement>;
    const card = wrapper.querySelector('#history-message-card') as HTMLElement;
    
    // Card Elements
    const cardName = wrapper.querySelector('#card-name') as HTMLElement;
    const cardYear = wrapper.querySelector('#card-year') as HTMLElement;
    const cardQuote = wrapper.querySelector('#card-quote') as HTMLElement;
    const cardSource = wrapper.querySelector('#card-source') as HTMLElement;
    const cardAvatarImg = wrapper.querySelector('#card-avatar-img') as HTMLImageElement;

    // Data extraction from DOM (or embedded JSON if preferred, but DOM is fine for assets)
    // Actually, let's embed the data as a clean JSON script for robustness
    const figuresData = [
      {
        name: 'St. Augustine',
        year: '430 AD',
        quote: 'Waktu itu juga (ketika masih bayi) aku tidak tahu bahasa Latin; tetapi aku mempelajarinya tanpa rasa takut atau penderitaan, hanya dengan pengamatan... Aku mempelajari kata-kata bukan dari mereka yang mengajar, tetapi dari mereka yang berbicara denganku.',
        source: 'Confessions (Book I, Chapter 14)',
        colorBorder: 'border-amber-400',
        colorText: 'text-amber-400'
      },
      {
        name: 'Dante Alighieri',
        year: '1321',
        quote: 'Saya menyatakan bahwa bahasa sehari-hari adalah bahasa yang kita pelajari tanpa instruksi formal, dengan meniru pengasuh kita... [bahasa] ini alami bagi kita, sementara tata bahasa lainnya, sebaliknya, bersifat buatan.',
        source: 'De Vulgari Eloquentia',
        colorBorder: 'border-rose-400',
        colorText: 'text-rose-400'
      },
      {
        name: 'Ibn Khaldun',
        year: '1406',
        quote: 'Itu karena bahasa Arab hanya dapat dikuasai melalui pengulangan ucapan dan latihan terus-menerus sesuai dengan cara orang Arab... [Hal itu] tidak diperoleh melalui pemahaman aturan tata bahasa.',
        source: 'The Muqaddimah',
        colorBorder: 'border-emerald-400',
        colorText: 'text-emerald-400'
      },
      {
        name: 'Michel de Montaigne',
        year: '1592',
        quote: 'Tanpa seni, tanpa buku, tanpa tata bahasa, tanpa aturan, tanpa cambuk, dan tanpa air mata, aku telah mempelajari Latin semurni yang diketahui oleh guru sekolahku.',
        source: 'On Educating Children',
        colorBorder: 'border-blue-400',
        colorText: 'text-blue-400'
      },
      {
        name: 'Desiderius Erasmus',
        year: '1536',
        quote: 'Saya tidak sabar dengan kebodohan guru tata bahasa pada umumnya... Sebab, kita tidak memperoleh kemampuan berbicara bahasa dengan mempelajari aturan-aturan, melainkan melalui interaksi sehari-hari.',
        source: 'De Ratione Studii',
        colorBorder: 'border-purple-400',
        colorText: 'text-purple-400'
      }
    ];

    let currentIndex = 0;
    let autoPlayInterval: any;
    const AUTO_DELAY = 6000; // 6 seconds

    const activateFigure = (index: number) => {
      // 1. Deactivate all buttons
      btns.forEach(btn => {
        const ring = btn.querySelector('.active-ring');
        const overlay = btn.querySelector('.overlay-dim');
        const img = btn.querySelector('img');
        
        if(ring) ring.className = 'active-ring absolute inset-0 border-4 border-transparent transition-colors duration-300 rounded-2xl';
        if(overlay) overlay.classList.remove('opacity-0');
        if(overlay) overlay.classList.add('bg-black/40');
      });

      // 2. Activate target button
      const targetBtn = btns[index];
      const data = figuresData[index];
      const targetImg = targetBtn.querySelector('img'); // Get the CldImage src from the button

      if (targetBtn) {
        const ring = targetBtn.querySelector('.active-ring');
        const overlay = targetBtn.querySelector('.overlay-dim');
        
        // Add specific color border
        if(ring) ring.className = `active-ring absolute inset-0 border-4 ${data.colorBorder} transition-colors duration-300 rounded-2xl shadow-[0_0_15px_rgba(255,255,255,0.3)]`;
        if(overlay) overlay.classList.remove('bg-black/40');
        if(overlay) overlay.classList.add('opacity-0');
      }

      // 3. Update Card Content (with animation)
      // Fade Out
      card.classList.remove('opacity-100', 'translate-y-0', 'scale-100');
      card.classList.add('opacity-0', 'translate-y-4', 'scale-95');

      setTimeout(() => {
        if(cardName) cardName.textContent = data.name;
        if(cardName) cardName.className = `font-bold text-sm sm:text-base md:text-xl uppercase tracking-tight ${data.colorText}`; // Color the name
        
        if(cardYear) cardYear.textContent = data.year;
        if(cardQuote) cardQuote.textContent = `"${data.quote}"`;
        if(cardSource) cardSource.textContent = data.source;
        if(cardAvatarImg && targetImg) cardAvatarImg.src = targetImg.src;

        // Fade In
        card.classList.remove('opacity-0', 'translate-y-4', 'scale-95');
        card.classList.add('opacity-100', 'translate-y-0', 'scale-100');
      }, 300); // Wait for fade out
      
      currentIndex = index;
    };

    const nextSlide = () => {
      const nextIndex = (currentIndex + 1) % figuresData.length;
      activateFigure(nextIndex);
    };

    const startAutoPlay = () => {
      clearInterval(autoPlayInterval); // Clear existing
      autoPlayInterval = setInterval(nextSlide, AUTO_DELAY);
    };

    const stopAutoPlay = () => {
      clearInterval(autoPlayInterval);
    };

    // Event Listeners
    btns.forEach((btn, idx) => {
      btn.addEventListener('click', () => {
        stopAutoPlay();
        activateFigure(idx);
        // Optional: Restart autoplay after a long pause? No, manual override usually means "let me read".
      });
    });

    // Keyboard Navigation (Arrow keys)
    wrapper.addEventListener('keydown', (e) => {
      const key = (e as KeyboardEvent).key;
      if (key === 'ArrowRight' || key === 'ArrowDown') {
        e.preventDefault();
        stopAutoPlay();
        const nextIndex = (currentIndex + 1) % figuresData.length;
        activateFigure(nextIndex);
        btns[nextIndex]?.focus();
      } else if (key === 'ArrowLeft' || key === 'ArrowUp') {
        e.preventDefault();
        stopAutoPlay();
        const prevIndex = (currentIndex - 1 + figuresData.length) % figuresData.length;
        activateFigure(prevIndex);
        btns[prevIndex]?.focus();
      }
    });

    // Initialize
    activateFigure(0);
    startAutoPlay();
  }

  // Run on load
  document.addEventListener('astro:page-load', initHistoryBiome);
  // Fallback for non-view-transitions
  if (document.readyState === 'complete') {
      initHistoryBiome();
  } else {
      document.addEventListener('DOMContentLoaded', initHistoryBiome);
  }
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
