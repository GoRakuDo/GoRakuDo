---
import SearchForm from '../ui/SearchForm.astro';

export interface Props {
  initialQuery?: string;
  initialCategory?: string;
  initialTag?: string;
}

const {
  initialQuery = '',
  initialCategory = '',
  initialTag = '',
} = Astro.props;
---

<section class='search-section'>
  <header class='section-header'>
    <h2 class='section-title'>Cari Konten</h2>
    <p class='section-description'>Cari melalui semua konten GoRakuDo</p>
  </header>

  <!-- 検索バー -->
  <div class='search-bar-container'>
    <SearchForm
      placeholder='Cari dokumentasi dan tutorial...'
      searchAction='/search'
      inputId='search-input'
      formId='search-form'
      size='lg'
      variant='glassmorphism'
      ariaLabel='Cari dokumentasi dan tutorial'
      submitButtonText='Cari'
      initialValue={initialQuery}
    />
  </div>

  <!-- 検索結果 -->
  <div class='search-results' id='search-results'>
    <div id='search-filters' class='search-active-filters'>
      {
        initialQuery && (
          <button
            class='filter-chip'
            data-type='q'
            data-value={initialQuery}
            aria-label={`Hapus kueri: ${initialQuery}`}
          >
            q: {initialQuery}
            <span class='chip-close' aria-hidden='true'>
              ×
            </span>
          </button>
        )
      }
      {
        initialCategory && (
          <button
            class='filter-chip'
            data-type='category'
            data-value={initialCategory}
            aria-label={`Hapus kategori: ${initialCategory}`}
          >
            category: {initialCategory}
            <span class='chip-close' aria-hidden='true'>
              ×
            </span>
          </button>
        )
      }
      {
        initialTag && (
          <button
            class='filter-chip'
            data-type='tag'
            data-value={initialTag}
            aria-label={`Hapus tag: ${initialTag}`}
          >
            tag: {initialTag}
            <span class='chip-close' aria-hidden='true'>
              ×
            </span>
          </button>
        )
      }
      {
        (initialQuery || initialCategory || initialTag) && (
          <button
            class='filter-clear'
            id='filter-clear-all'
            aria-label='Hapus semua filter'
          >
            Hapus Semua
          </button>
        )
      }
    </div>
    {
      initialQuery && (
        <div class='search-results-container' role='list' aria-busy='true'>
          <div class='skeleton-card' aria-hidden='true' />
          <div class='skeleton-card' aria-hidden='true' />
          <div class='skeleton-card' aria-hidden='true' />
        </div>
      )
    }
  </div>
</section>

<script>
  import Fuse from 'fuse.js';
  import DOMPurify from 'dompurify';

  type SearchItem = {
    title: string;
    description: string;
    content: string;
    tags: string[];
    categories: string[];
    toolName?: string;
    type: 'docs' | 'tool-article' | 'page';
    url: string;
    path: string;
    pubDate: string;
  };

  class SearchManager {
    private data: SearchItem[] = [];
    private fuse: any = null;
    constructor() {
      this.initializeSearch();
    }
    async initializeSearch() {
      try {
        const response = await fetch('/search/Search.json');
        const searchData = await response.json();
        this.data = (searchData?.data || []) as SearchItem[];
        this.fuse = new Fuse(this.data, {
          keys: [
            { name: 'title', weight: 0.4 },
            { name: 'description', weight: 0.3 },
            { name: 'content', weight: 0.2 },
            { name: 'tags', weight: 0.1 },
            { name: 'categories', weight: 0.05 },
            { name: 'toolName', weight: 0.05 },
          ],
          threshold: 0.4,
          includeScore: true,
          includeMatches: true,
          minMatchCharLength: 2,
          shouldSort: true,
          findAllMatches: true,
          useExtendedSearch: true,
          ignoreLocation: true,
        });
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q');
        const initialCategory = urlParams.get('category');
        const initialTag = urlParams.get('tag');
        if (initialQuery) {
          this.performSearch(initialQuery);
        } else if (initialCategory || initialTag) {
          this.performFilter({
            category: initialCategory || undefined,
            tag: initialTag || undefined,
          });
        }
      } catch (error) {
        console.error('Failed to initialize comprehensive search:', error);
      }
    }
    performSearch(query: string) {
      if (!this.fuse || !query.trim()) {
        this.clearResults();
        return;
      }
      const results = this.fuse.search(query) as Array<{
        item: SearchItem;
        score?: number;
      }>;
      this.displayResults(results);
    }
    performFilter(filter: { category?: string; tag?: string }) {
      if (!this.data || this.data.length === 0) return;
      let filtered = this.data;
      if (filter.category) {
        filtered = filtered.filter(i =>
          (i.categories || []).includes(filter.category as string)
        );
      }
      if (filter.tag) {
        filtered = filtered.filter(i =>
          (i.tags || []).includes(filter.tag as string)
        );
      }
      const results = filtered.map(item => ({ item }));
      this.displayResults(results);
    }
    displayResults(
      results: Array<{ item: SearchItem; score?: number; matches?: any[] }>
    ) {
      const resultsContainer = document.getElementById('search-results');
      if (!resultsContainer) return;
      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <div class='search-results-container'>
            <div class='loading-indicator'>Tidak ada hasil ditemukan</div>
          </div>`;
        return;
      }
      const escapeHtml = (str: string) => DOMPurify.sanitize(String(str || ''));
      const highlight = (
        text: string,
        indices: Array<[number, number]> | undefined
      ) => {
        // ハイライト機能を無効化 - 常にプレーンテキストを返す
        return escapeHtml(text);
      };
      const buildSnippet = (
        content: string,
        indices: Array<[number, number]> | undefined
      ) => {
        if (!indices || indices.length === 0 || !content) return '';
        const [start, end] = indices[0];
        const pad = 50;
        const s = Math.max(0, start - pad);
        const e = Math.min(content.length, end + 1 + pad);
        const prefix = s > 0 ? '…' : '';
        const suffix = e < content.length ? '…' : '';
        const segment = content.slice(s, e);
        // ハイライトなしでプレーンテキストを返す
        return `${prefix}${escapeHtml(segment)}${suffix}`;
      };

      const resultsHTML = results
        .map((result, index) => {
          const item = result.item;
          const matches = (result as any).matches as any[] | undefined;
          const titleMatch = matches?.find(m => m.key === 'title');
          const descMatch = matches?.find(m => m.key === 'description');
          const contentMatch = matches?.find(m => m.key === 'content');

          const titleHtml = titleMatch
            ? highlight(item.title || '', titleMatch.indices)
            : escapeHtml(item.title || '');
          const descHtml = descMatch
            ? highlight(item.description || '', descMatch.indices)
            : escapeHtml(item.description || '');
          const snippetHtml = contentMatch
            ? buildSnippet(item.content || '', contentMatch.indices)
            : '';

          const badgeClass =
            item.type === 'docs'
              ? 'result-badge--docs'
              : item.type === 'tool-article'
                ? 'result-badge--tool'
                : 'result-badge--page';
          const badgeText =
            item.type === 'docs'
              ? 'Documentation'
              : item.type === 'tool-article'
                ? item.toolName || 'Tool'
                : 'Page';
          return `
          <a href="${escapeHtml(item.url)}" class='search-result-item' style="animation-delay: ${index * 50}ms">
            <div class='result-title'>${titleHtml}</div>
            <div class='result-description'>${descHtml}</div>
            ${snippetHtml ? `<div class='result-snippet'>${snippetHtml}</div>` : ''}
            <div class='result-meta'>
              <span class='result-type ${badgeClass}'>${escapeHtml(badgeText)}</span>
              <span class='result-path'>${escapeHtml(item.path)}</span>
              <span class='result-date'>${escapeHtml(new Date(item.pubDate).toLocaleDateString())}</span>
            </div>
          </a>`;
        })
        .join('');
      resultsContainer.innerHTML = `
        <div class='search-results-header' aria-live='polite'>${results.length} results</div>
        <div class='search-results-container' role='list' aria-busy='false'>${resultsHTML}</div>
      `;
      // Set role for accessibility
      document.querySelectorAll('.search-result-item').forEach((el, index) => {
        (el as HTMLElement).setAttribute('role', 'listitem');
      });
    }
    clearResults() {
      const resultsContainer = document.getElementById('search-results');
      if (resultsContainer) {
        resultsContainer.innerHTML = '';
      }
    }
  }
  const searchManager = new SearchManager();
  document.getElementById('search-form')?.addEventListener('submit', e => {
    e.preventDefault();
    const query = (document.getElementById('search-input') as HTMLInputElement)
      .value;
    const url = new URL(window.location as any);
    url.searchParams.set('q', query);
    window.history.pushState({}, '', url);
    searchManager.performSearch(query);
  });
  let searchTimeout: ReturnType<typeof setTimeout> | undefined;
  document
    .getElementById('search-input')
    ?.addEventListener('input', (e: any) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = (e.target as HTMLInputElement).value;
        if (query.length >= 2) {
          searchManager.performSearch(query);
        } else {
          searchManager.clearResults();
        }
      }, 300);
    });

  // Get input element for URL sync
  const inputEl = document.getElementById(
    'search-input'
  ) as HTMLInputElement | null;

  // Clear chips and URL sync
  const filtersEl = document.getElementById('search-filters');
  const clearBtn = document.getElementById('filter-clear-all');
  function updateUrl(params: Record<string, string | null>) {
    const url = new URL(window.location.href);
    Object.entries(params).forEach(([k, v]) => {
      if (v === null) url.searchParams.delete(k);
      else url.searchParams.set(k, v);
    });
    window.history.pushState({}, '', url);
  }
  function reapplyFromUrl() {
    const url = new URL(window.location.href);
    const q = url.searchParams.get('q') || '';
    const category = url.searchParams.get('category') || '';
    const tag = url.searchParams.get('tag') || '';
    if (inputEl) inputEl.value = q;
    if (q) searchManager.performSearch(q);
    else
      searchManager.performFilter({
        category: category || undefined,
        tag: tag || undefined,
      });
  }
  if (filtersEl) {
    filtersEl.addEventListener('click', e => {
      const target = e.target as HTMLElement;
      const chip = target.closest('.filter-chip') as HTMLElement | null;
      if (chip) {
        const type = chip.getAttribute('data-type');
        if (type === 'q') {
          updateUrl({ q: null });
        }
        if (type === 'category') {
          updateUrl({ category: null });
        }
        if (type === 'tag') {
          updateUrl({ tag: null });
        }
        reapplyFromUrl();
        return;
      }
    });
  }
  if (clearBtn) {
    clearBtn.addEventListener('click', e => {
      e.preventDefault();
      updateUrl({ q: null, category: null, tag: null });
      reapplyFromUrl();
    });
  }

  // Cross-section filter events
  document.addEventListener('search:category-selected', (e: any) => {
    const category = e?.detail?.category || '';
    searchManager.performFilter({ category });
  });
  document.addEventListener('search:tag-selected', (e: any) => {
    const tag = e?.detail?.tag || '';
    searchManager.performFilter({ tag });
  });
</script>
