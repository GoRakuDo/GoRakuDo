---
// ========== POST LAYOUT COMPONENT ==========
// Centralized layout management following ArticleLayout pattern
// All content sections are provided through named slots
import UnifiedSEO from '../components/UnifiedSEO.astro';
import TableOfContents from '../components/content/TableOfContents.astro';

import Navbar from '../components/common/NavBar/Navbar.astro';
import BottomNavBar from '../components/common/NavBar/BottomNavBar.astro';

import Prose from '../components/Prose.astro';

// Global CSS
import '../styles/global.css';

export interface Props {
  title: string;
  description: string;
  publishedDate?: string;
  lang?: 'id' | 'ja';
  author?: string;
  tags?: string[];
  // Post-specific props
  post?:
    | import('astro:content').CollectionEntry<'docs'>
    | import('astro:content').CollectionEntry<'tool-articles'>;
  collectionMetadata?: {
    displayName: string;
    basePath: string;
  };
  headings?: { depth: number; slug: string; text: string }[];
  postActions?: boolean;
  // Featured image from ContentCollection
  featuredImage?: string;
  // Content article configuration
  contentConfig?: {
    id?: string;
    ariaLabel?: string;
    className?: string;
  };
  // Breadcrumb configuration
  breadcrumbConfig?: {
    currentPath?: string;
    showHome?: boolean;
    variant?: 'compact' | 'spacious' | 'minimal' | 'pill' | 'underline';
    showIcons?: boolean;
    ariaLabel?: string;
  };
  // Breadcrumb Schema統合
  breadcrumbSchema?: {
    '@context': 'https://schema.org';
    '@type': 'BreadcrumbList';
    itemListElement: Array<{
      '@type': 'ListItem';
      position: number;
      name: string;
      item: string;
    }>;
  };
  // FAQ Schema統合
  faqSchema?: {
    '@context': 'https://schema.org';
    '@type': 'FAQPage';
    mainEntity: Array<{
      '@type': 'Question';
      name: string;
      acceptedAnswer: {
        '@type': 'Answer';
        text: string;
      };
    }>;
  } | null;
}

const {
  title,
  description,
  publishedDate,
  lang = 'id',
  author,
  tags = [],
  headings,
  contentConfig = {},
  breadcrumbSchema,
  faqSchema,
  featuredImage,
} = Astro.props;
---

<!doctype html>
<html lang={lang}>
  <head>
    <UnifiedSEO
      title={title}
      description={description}
      keywords={tags}
      lang={lang}
      pageType='article'
      author={author}
      publishedDate={publishedDate}
      modifiedDate={publishedDate}
      image={featuredImage}
      breadcrumbSchema={breadcrumbSchema}
      faqSchema={faqSchema}
    />
  </head>
  <body>
    <!-- Navigation - 共通コンポーネント -->
    <Navbar />
    <BottomNavBar />

    <!-- Main Content -->
    <main
      class='content-page items-center justify-center w-full max-w-full flex flex-col'
      role='main'
      style='padding-top: 5rem;'
    >
      <div class='content-wrapper'>
        <!-- Content Container - Grid Area: content -->
        <div class='content-container'>
          <!-- Breadcrumb Navigation - Inside content-container -->
          <div class='breadcrumb-container'>
            <slot name='breadcrumb' />
          </div>

          <!-- Article Header Slot -->
          <slot name='header' />

          <!-- Article Content Slot -->
          <article
            class={`max-w-none content-main ${contentConfig.className || ''}`}
            id={contentConfig.id || 'contentMain'}
            aria-label={contentConfig.ariaLabel || 'Post content'}
          >
            <Prose>
              <slot name='content' />
            </Prose>
          </article>

          <!-- Post Actions Slot -->
          <slot name='actions' />

          <!-- Additional Footer Content Slot -->
          <slot name='footer' />
        </div>

        <!-- Sidebar Container - Grid Area: toc -->
        <div class='sidebar-container'>
          <!-- Table of Contents Sidebar Slot -->
          <slot name='sidebar'>
            <!-- Default Table of Contents implementation -->
            {
              headings && headings.length > 0 && (
                <TableOfContents headings={headings} />
              )
            }
          </slot>

          <!-- Additional Sidebar Content Slot -->
          <slot name='additional-sidebar' />
        </div>
      </div>
    </main>

    <!-- Breadcrumb Scroll Animation Script -->
    <script>
      // スマホ画面でのbreadcrumb-containerのスクロールアニメーション
      function initBreadcrumbScrollAnimation() {
        const breadcrumbContainer = document.querySelector(
          '.breadcrumb-container'
        ) as HTMLElement;

        if (!breadcrumbContainer || window.innerWidth > 767) {
          return; // スマホ画面以外では実行しない
        }

        let scrollTimeout: number;
        let isScrolling = false;

        // スクロール可能な状態をチェック
        function checkScrollable() {
          if (!breadcrumbContainer) return;

          const { scrollLeft, scrollWidth, clientWidth } = breadcrumbContainer;

          // 左側にスクロール可能かチェック
          if (scrollLeft > 0) {
            breadcrumbContainer.classList.add('scrollable-left');
          } else {
            breadcrumbContainer.classList.remove('scrollable-left');
          }

          // 右側にスクロール可能かチェック
          if (scrollLeft < scrollWidth - clientWidth) {
            breadcrumbContainer.classList.add('scrollable-right');
          } else {
            breadcrumbContainer.classList.remove('scrollable-right');
          }
        }

        // スクロール開始時のアニメーション
        function handleScrollStart() {
          if (!breadcrumbContainer || isScrolling) return;

          isScrolling = true;
          breadcrumbContainer.classList.add('scrolling');
        }

        // スクロール終了時のアニメーション
        function handleScrollEnd() {
          if (!breadcrumbContainer) return;

          isScrolling = false;
          breadcrumbContainer.classList.remove('scrolling');
        }

        // スクロールイベントリスナー
        breadcrumbContainer.addEventListener('scroll', () => {
          handleScrollStart();
          checkScrollable();

          // スクロール終了を検出
          clearTimeout(scrollTimeout);
          scrollTimeout = window.setTimeout(handleScrollEnd, 150);
        });

        // 初期状態をチェック
        checkScrollable();

        // リサイズ時に再チェック
        window.addEventListener('resize', () => {
          if (!breadcrumbContainer) return;

          if (window.innerWidth <= 767) {
            setTimeout(checkScrollable, 100);
          } else {
            // デスクトップ画面ではクラスを削除
            breadcrumbContainer.classList.remove(
              'scrollable-left',
              'scrollable-right',
              'scrolling'
            );
          }
        });
      }

      // DOM読み込み完了後に実行
      if (document.readyState === 'loading') {
        document.addEventListener(
          'DOMContentLoaded',
          initBreadcrumbScrollAnimation
        );
      } else {
        initBreadcrumbScrollAnimation();
      }
    </script>
  </body>
</html>
