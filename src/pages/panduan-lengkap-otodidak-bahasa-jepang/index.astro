---
// Japanese Learning Guide Page - 2025å¹´SEOæœ€é©åŒ–
import BaseLayout from '../../layouts/BaseLayout.astro';
import Prose from '../../components/Prose.astro';
import { generateBreadcrumbSchema } from '../../utils/breadcrumb-schema';

import '../../styles/pages/pl-obj/pl-objIndex.css';

import { getCollection } from 'astro:content';

// SEOãƒ‡ãƒ¼ã‚¿ã¨æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import panduanSeoData from './_panduan-seo.json';
import gorakudoImmerisonImage from '../../assets/images/pages/pl-obj/gorakudo-immerison.png';

// Get the specific page from the pages collection
const pages = await getCollection('pages');
const entry = pages.find(
  page => page.slug === 'panduan-lengkap-otodidak-bahasa-jepang'
);

// Error handling if page not found
if (!entry) {
  throw new Error(
    'Page "panduan-lengkap-otodidak-bahasa-jepang" not found in pages collection'
  );
}

const { Content } = await entry.render();

// 2025å¹´SEOæœ€é©åŒ–: JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—
const seoData = panduanSeoData.seoData;
const structuredData = panduanSeoData.structuredData;

// Breadcrumb Schemaç”Ÿæˆ
const breadcrumbSchema = generateBreadcrumbSchema({
  items: panduanSeoData.breadcrumbData.items.map((item, index) => ({
    title: item.name,
    url: item.url,
    isActive: index === panduanSeoData.breadcrumbData.items.length - 1,
  })),
  siteUrl: String(Astro.site || 'https://gorakudo.org'),
});

// FAQ Schemaç”Ÿæˆ
const faqSchema = {
  '@context': 'https://schema.org' as const,
  '@type': 'FAQPage' as const,
  mainEntity: structuredData.faq.mainEntity.map(faq => ({
    '@type': 'Question' as const,
    name: faq.name,
    acceptedAnswer: {
      '@type': 'Answer' as const,
      text: faq.acceptedAnswer.text,
    },
  })),
} as const;
---

<BaseLayout
  title={seoData.title}
  description={seoData.description}
  keywords={seoData.keywords}
  lang={seoData.lang}
  pageType={seoData.pageType as 'article' | 'website'}
  publishedDate={entry.data.publishedDate}
  ogImage={gorakudoImmerisonImage.src}
  breadcrumbSchema={breadcrumbSchema}
  faqSchema={faqSchema}
>
  <!-- 2025å¹´SEOæœ€é©åŒ–: æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ -->
  <script
    type='application/ld+json'
    set:html={JSON.stringify({
      ...structuredData.article,
      image: {
        '@type': 'ImageObject',
        url: gorakudoImmerisonImage.src,
        width: 1200,
        height: 1200,
      },
    })}
  />
  <script
    type='application/ld+json'
    set:html={JSON.stringify({
      ...structuredData.howTo,
      image: gorakudoImmerisonImage.src,
    })}
  />

  <!-- 2025å¹´SEOæœ€é©åŒ–: æŠ€è¡“çš„SEOè¦ç´  -->
  <link
    rel='canonical'
    href='https://gorakudo.org/panduan-lengkap-otodidak-bahasa-jepang/'
  />
  <meta
    name='robots'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />
  <meta
    name='googlebot'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />
  <meta
    name='bingbot'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />

  <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– -->
  <link rel='preconnect' href='https://fonts.googleapis.com' />
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />

  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <meta http-equiv='X-Content-Type-Options' content='nosniff' />
  <meta http-equiv='X-XSS-Protection' content='1; mode=block' />
  <meta
    http-equiv='Referrer-Policy'
    content='strict-origin-when-cross-origin'
  />

  <Prose>
    <main class='pl-guide-page' role='main'>
      <div class='container'>
        <Content />
      </div>
    </main>
  </Prose>
</BaseLayout>

<script>
  // Lazy import for image zoom functionality
  let imageZoomLoaded = false;
  let imageZoomInstance: { openModal: (event: any) => void } | null = null;
  let imageZoomPromise: Promise<{ openModal: (event: any) => void }> | null =
    null;

  const loadImageZoom = async () => {
    // æ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®å ´åˆã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
    if (imageZoomLoaded && imageZoomInstance) {
      return imageZoomInstance;
    }

    // æ—¢ã«ãƒ­ãƒ¼ãƒ‰ä¸­ã®å ´åˆã¯Promiseã‚’è¿”ã™
    if (imageZoomPromise) {
      return imageZoomPromise;
    }

    // æ–°ã—ã„ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
    imageZoomPromise = (async () => {
      try {
        if (import.meta.env.DEV) console.log('Loading ImageZoom script...');
        const { default: ImageZoom } = await import(
          '../../scripts/image-zoom.js'
        );

        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        imageZoomInstance = new ImageZoom();
        imageZoomLoaded = true;

        if (import.meta.env.DEV) console.log('ImageZoom loaded successfully');
        return imageZoomInstance;
      } catch (error) {
        console.error('Failed to load ImageZoom:', error);
        imageZoomPromise = null; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯Promiseã‚’ãƒªã‚»ãƒƒãƒˆ
        throw error;
      }
    })();

    return imageZoomPromise;
  };

  const handleImageZoomClick = async (event: Event) => {
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ã‚’äº‹å‰ã«ä¿å­˜
    const currentTarget = event.currentTarget;
    const target = event.target;

    if (import.meta.env.DEV) {
      console.log('handleImageZoomClick called');
      console.log('Original event currentTarget:', currentTarget);
      console.log('Original event target:', target);
    }

    try {
      // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
      const zoomInstance = await loadImageZoom();

      if (zoomInstance) {
        // ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ­£ã—ãæ§‹ç¯‰
        const syntheticEvent = {
          currentTarget: currentTarget,
          target: target,
          preventDefault: () => event.preventDefault(),
          stopPropagation: () => event.stopPropagation(),
        };

        if (import.meta.env.DEV) {
          console.log('Synthetic event:', syntheticEvent);
          console.log(
            'Synthetic event currentTarget:',
            syntheticEvent.currentTarget
          );
        }

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
        zoomInstance.openModal(syntheticEvent);
      }
    } catch (error) {
      console.error('ImageZoom failed to load:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
      if (currentTarget && 'querySelector' in currentTarget) {
        const img = (currentTarget as Element).querySelector('img');
        if (img && 'src' in img) {
          window.open((img as HTMLImageElement).src, '_blank');
        }
      }
    }
  };

  // ç”»åƒã‚ºãƒ¼ãƒ ãƒˆãƒªã‚¬ãƒ¼ã®åˆæœŸåŒ–
  const initializeLazyImageZoom = () => {
    const triggers = document.querySelectorAll('.image-zoom-trigger');
    if (import.meta.env.DEV) {
      console.log(
        'Initializing lazy image zoom for',
        triggers.length,
        'triggers'
      );
    }

    // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½è·¡
    const initializedTriggers = new WeakSet();

    triggers.forEach(trigger => {
      // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (initializedTriggers.has(trigger)) return;

      initializedTriggers.add(trigger);

      // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      const clickHandler = (event: Event) => {
        if (import.meta.env.DEV) {
          console.log('Click handler called with event:', event);
          console.log('Event currentTarget:', event.currentTarget);
        }
        handleImageZoomClick(event);
      };

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      const keydownHandler = ((e: KeyboardEvent) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleImageZoomClick(e);
        }
      }) as EventListener;

      trigger.addEventListener('click', clickHandler);
      trigger.addEventListener('keydown', keydownHandler);
    });
  };

  // DOMæº–å‚™å®Œäº†æ™‚ã«åˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeLazyImageZoom);
  } else {
    initializeLazyImageZoom();
  }

  // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
  const cleanupImageZoom = () => {
    imageZoomInstance = null;
    imageZoomPromise = null;
    imageZoomLoaded = false;
  };

  // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
  if (import.meta.env.DEV) {
    (window as any).imageZoomDebug = {
      loadImageZoom,
      handleImageZoomClick,
      initializeLazyImageZoom,
      cleanupImageZoom,
      getLoaded: () => imageZoomLoaded,
      getInstance: () => imageZoomInstance,
    };
  }

  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  window.addEventListener('beforeunload', cleanupImageZoom);

  // 2025å¹´SEOæœ€é©åŒ–: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  if ('performance' in window && 'mark' in performance) {
    performance.mark('panduan-page-start');
  }

  // 2025å¹´SEOæœ€é©åŒ–: Core Web Vitalsç›£è¦–
  if ('web-vital' in window) {
    console.log('ğŸ“Š Core Web Vitals monitoring enabled for panduan page');
  }

  // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸIntersection Observer
  const initLazyLoading = () => {
    const lazyElements = document.querySelectorAll('[data-lazy]');

    if (lazyElements.length === 0) return;

    const lazyObserver = new IntersectionObserver(
      entries => {
        entries.forEach((entry, index) => {
          if (entry.isIntersecting) {
            requestAnimationFrame(() => {
              const delay = Math.min(index * 100, 500);
              setTimeout(() => {
                entry.target.classList.add('loaded');
                lazyObserver.unobserve(entry.target);
              }, delay);
            });
          }
        });
      },
      {
        rootMargin: '100px 0px -5% 0px',
        threshold: [0.05, 0.1],
      }
    );

    lazyElements.forEach(el => lazyObserver.observe(el));
  };

  // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸåˆæœŸåŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLazyLoading);
  } else {
    initLazyLoading();
  }
</script>
