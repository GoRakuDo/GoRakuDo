---
import BaseLayout from '../layouts/BaseLayout.astro';

// Homepage specific components
import Hero from '../components/homepage/hero.astro';
import MissionSection from '../components/homepage/MissionSection.astro';
import FeaturesSection from '../components/homepage/FeaturesSection.astro';
import DocumentationPreviewSection from '../components/homepage/DocumentationPreviewSection.astro';

// Breadcrumb Schema
import { generateBreadcrumbSchema } from '../utils/breadcrumb-schema';

// CSSã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import '../styles/pages/homepage.css';

// SEOãƒ‡ãƒ¼ã‚¿ã¨æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import indexData from './_index.json';

// å‹å®‰å…¨ãªSEOãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆAstroãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰
interface SEOData {
  title: string;
  description: string;
  keywords: string[];
  pageType: 'website' | 'article';
  image?: string;
  author?: string;
  lang?: 'id' | 'ja'; // è¨€èªè¨­å®šã‚’è¿½åŠ ï¼ˆBaseLayoutã®Propsã¨ä¸€è‡´ï¼‰
}

const seoData: SEOData = indexData.seoData as SEOData;

// Homepageç”¨ã®Breadcrumb Schemaç”Ÿæˆ
const breadcrumbSchema = generateBreadcrumbSchema({
  items: [{ title: 'Home', url: '/', isActive: true }],
  siteUrl: String(Astro.site || 'https://gorakudo.org'),
});

// ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å›ºæœ‰ã®FAQæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: indexData.homepageSpecificData.faq.map(
    faq =>
      ({
        '@type': 'Question',
        name: faq.question,
        acceptedAnswer: {
          '@type': 'Answer',
          text: faq.answer,
        },
      }) as const
  ),
} as const;
---

<BaseLayout
  title={seoData.title}
  description={seoData.description}
  keywords={seoData.keywords}
  pageType={seoData.pageType}
  lang={seoData.lang}
  breadcrumbSchema={breadcrumbSchema}
  faqSchema={faqSchema}
>
  <!-- 2025å¹´SEOæœ€é©åŒ–: æŠ€è¡“çš„SEOè¦ç´  -->
  <link rel='canonical' href='https://gorakudo.org/' />
  <meta
    name='robots'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />
  <meta
    name='googlebot'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />
  <meta
    name='bingbot'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />

  <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– -->
  <link rel='preconnect' href='https://fonts.googleapis.com' />
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />
  <link rel='dns-prefetch' href='https://discord.gg' />
  <link rel='dns-prefetch' href='https://github.com' />
  <link rel='dns-prefetch' href='https://www.youtube.com' />

  <!-- é‡è¦ãªãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ -->
  <!-- FullDC Logo.webp ã¯SEOãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã§ã®ã¿ä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ã€preloadã‚’å‰Šé™¤ -->

  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <meta http-equiv='X-Content-Type-Options' content='nosniff' />
  <meta http-equiv='X-XSS-Protection' content='1; mode=block' />
  <meta
    http-equiv='Referrer-Policy'
    content='strict-origin-when-cross-origin'
  />

  <!-- Main Content -->
  <main
    class='main-content'
    style='background: transparent;'
    transition:name='main-content'
    role='main'
    aria-label='Konten utama GoRakuDo'
  >
    <!-- Hero Section -->
    <Hero
      missionId='mission'
      titleLine1={indexData.homepageSpecificData.heroTitle.line1}
      titleLine2={indexData.homepageSpecificData.heroTitle.line2}
    />

    <!-- Mission Section -->
    <MissionSection />

    <!-- Features Section -->
    <FeaturesSection />

    <!-- Documentation Preview Section -->
    <DocumentationPreviewSection />
  </main>

  <!-- Enhanced wave animation is now handled by WaveAnimation component -->
  <!-- <script fetchpriority="auto" is:inline src="/core/hompage-script.js"></script> -->

  <!-- 2025å¹´SEOæœ€é©åŒ–: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // 2025å¹´SEOæœ€é©åŒ–: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    if ('performance' in window && 'mark' in performance) {
      performance.mark('page-start');
    }

    // Stars animation is now integrated into WaveAnimation.astro
    // No separate import needed
    console.log('ğŸ¬ Animation modules integrated into WaveAnimation component');

    // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const initHeroAnimation = () => {
      const heroContent = document.querySelector('#hero-content');
      if (heroContent) {
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
        requestAnimationFrame(() => {
          heroContent.classList.remove(
            'opacity-0',
            'translate-y-16',
            'scale-80',
            'blur-md'
          );
          console.log('âœ¨ Hero content revealed smoothly');
        });
      }
    };

    // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initHeroAnimation, 200);
      });
    } else {
      setTimeout(initHeroAnimation, 200);
    }

    // Global function cleanup - following Astro's static-first philosophy
    (window as any).goToPosts = function () {
      window.location.href = '/docs';
    };

    // 2025å¹´SEOæœ€é©åŒ–: Core Web Vitalsç›£è¦–
    if ('web-vital' in window) {
      // Web Vitals monitoring would be implemented here
      console.log('ğŸ“Š Core Web Vitals monitoring enabled');
    }
  </script>

  <!-- 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸIntersection Observer -->
  <script>
    // 2025å¹´SEOæœ€é©åŒ–: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã•ã‚ŒãŸIntersection Observer
    const initLazyLoading = () => {
      const lazyElements = document.querySelectorAll('[data-lazy]');

      if (lazyElements.length === 0) return;

      // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®š
      const lazyObserver = new IntersectionObserver(
        entries => {
          entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
              // 2025å¹´SEOæœ€é©åŒ–: ãƒãƒƒãƒå‡¦ç†ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
              requestAnimationFrame(() => {
                const delay = Math.min(index * 100, 500); // æœ€å¤§500msã«åˆ¶é™

                setTimeout(() => {
                  entry.target.classList.add('loaded');
                  lazyObserver.unobserve(entry.target);
                }, delay);
              });
            }
          });
        },
        {
          // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®š
          rootMargin: '100px 0px -5% 0px', // ã‚ˆã‚Šæ—©ã„ãƒˆãƒªã‚¬ãƒ¼
          threshold: [0.05, 0.1], // è¤‡æ•°ã®é–¾å€¤ã§ã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œçŸ¥
        }
      );

      // 2025å¹´SEOæœ€é©åŒ–: ãƒãƒƒãƒå‡¦ç†ã§ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ç™»éŒ²
      lazyElements.forEach(el => lazyObserver.observe(el));
    };

    // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸåˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLazyLoading);
    } else {
      initLazyLoading();
    }

    // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸService Worker
    if ('serviceWorker' in navigator) {
      // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°
      const initServiceWorker = () => {
        // Opt-in only: enable by setting localStorage.setItem('enable-sw','true')
        const enableSW = localStorage.getItem('enable-sw') === 'true';

        if (enableSW) {
          navigator.serviceWorker
            .register('/sw.js', {
              // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸè¨­å®š
              scope: '/',
              updateViaCache: 'none', // å¸¸ã«æœ€æ–°ç‰ˆã‚’å–å¾—
            })
            .then(registration => {
              console.log('ğŸ”§ Service Worker registered:', registration.scope);

              // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸæ›´æ–°ãƒã‚§ãƒƒã‚¯
              registration.addEventListener('updatefound', () => {
                const installing = registration.installing;
                if (!installing) return;

                installing.addEventListener('statechange', () => {
                  if (installing.state === 'installed') {
                    if (navigator.serviceWorker.controller) {
                      console.log('ğŸ”„ New Service Worker available');
                      // 2025å¹´SEOæœ€é©åŒ–: è‡ªå‹•æ›´æ–°ã®ææ¡ˆ
                      if (
                        confirm(
                          'æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ'
                        )
                      ) {
                        window.location.reload();
                      }
                    } else {
                      console.log('âœ… Service Worker installed');
                    }
                  }
                });
              });
            })
            .catch(error => {
              console.log(
                'âš ï¸ Service Worker registration failed:',
                error?.message || error
              );
            });
        } else {
          // Disabled by default to avoid GH Pages cache/stale-content issues
          console.log(
            "ğŸ”§ Service Worker disabled (enable via localStorage 'enable-sw' = 'true')"
          );
        }
      };

      // 2025å¹´SEOæœ€é©åŒ–: æœ€é©åŒ–ã•ã‚ŒãŸåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initServiceWorker);
      } else {
        initServiceWorker();
      }
    }
  </script>
</BaseLayout>
