---
import { getEntry } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';
import Breadcrumb from '../../components/common/Breadcrumb.astro';
import TrakteerWidget from '../../components/content/TrakteerWidget.astro';
import { resolvePath, getCollectionInfo } from '../../utils/collections';
import { getMergedDates } from '../../utils/content/cc-Auto-FileDates';

import '../../styles/layouts/PostLayout.css';

const post = await getEntry('pages', 'support-us');

if (!post) {
  return Astro.redirect('/pages?error=post-not-found');
}

// ページのステータスをチェック（非公開の場合は404を返す）
if (post.data.status !== 'published') {
  return Astro.redirect('/404');
}

const { Content, headings } = await post.render();

const tocHeadings = headings.filter(
  (heading: { depth: number }) => heading.depth >= 2 && heading.depth <= 3
);

const resolvedPath = { path: resolvePath('pages', post.slug) };
const collectionMetadata = getCollectionInfo('pages');

// ファイルの作成日・更新日を自動取得（ユーティリティ使用）
const fileDates = getMergedDates(
  { slug: post.slug, collection: 'pages' },
  post.data.publishedDate,
  post.data.updatedDate
);

const seoData = {
  title: post.data.title || `Dukung Kami - GoRakuDo`,
  description:
    post.data.description ||
    `Dukung pengembangan GoRakuDo dan dapatkan apresiasi untuk kontribusi Anda dalam komunitas open-source ini.`,
  keywords: ['dukungan', 'kontributor', 'komunitas', 'open-source'],
  articleType: 'guide',
  learningStage: 'beginner',
  searchIntent: 'informational',
  publishedDate: fileDates.publishedDate,
  modifiedDate: fileDates.updatedDate,
  isDraft: false,
};

const postData = {
  title: post.data.title,
  description: post.data.description,
  resolvedPath: resolvedPath.path,
};

// Breadcrumb configuration
const breadcrumbConfig = {
  currentPath: resolvedPath.path,
  showHome: true,
  variant: 'compact' as const,
  showIcons: true,
  ariaLabel: 'Support us page navigation breadcrumb',
};
---

<PostLayout
  title={seoData.title}
  description={seoData.description}
  publishedDate={seoData.publishedDate}
  lang='id'
  author={post.data.author || 'Tim GoRakuDo'}
  tags={seoData.keywords}
  post={post}
  collectionMetadata={collectionMetadata}
  headings={tocHeadings}
  postActions={false}
  breadcrumbConfig={breadcrumbConfig}
>
  <!-- Breadcrumb Slot -->
  <Breadcrumb
    slot='breadcrumb'
    {post}
    currentPath={breadcrumbConfig.currentPath}
    showHome={breadcrumbConfig.showHome}
    variant={breadcrumbConfig.variant}
    showIcons={breadcrumbConfig.showIcons}
    ariaLabel={breadcrumbConfig.ariaLabel}
  />

  <!-- Header Slot -->
  <header slot='header' class='content-header mt-8'>
    <h1>{post.data.title}</h1>

    {
      (post.data.publishedDate || post.data.author) && (
        <div class='content-meta' aria-label='Post metadata'>
          <time class='content-date' datetime={seoData.publishedDate}>
            {new Date(seoData.publishedDate).toLocaleDateString('id-ID', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}
          </time>
          <span class='content-author'>
            by {post.data.author || 'Tim GoRakuDo'}
          </span>
        </div>
      )
    }

    {
      post.data.difficulty && (
        <div class='content-tags'>
          <span
            class={`difficulty-badge difficulty-${post.data.difficulty}`}
            aria-label={`Difficulty level: ${post.data.difficulty}`}
          >
            {post.data.difficulty}
          </span>
        </div>
      )
    }
  </header>

  <!-- Content Slot -->
  <article
    slot='content'
    class='prose prose-invert max-w-none content-main'
    id='contentMain'
    aria-label='Post content'
  >
    <div class='support-content'>
      <TrakteerWidget
        src='https://stream.trakteer.id/milestone/index.html?ms_font=Work+Sans&ms_icon=https%3A%2F%2Fedge-cdn.trakteer.id%2Fimages%2Fmix%2Fegis-in-bottle.png%3Fv%3D14-05-2025&ms_title=Project+Web+GoRakuDo&ms_1_clr1=rgba%28250%2C+250%2C+250%2C+0%29&ms_1_clr2=rgba%28103%2C+58%2C+183%2C+1%29&ms_1_clr4=rgba%280%2C+0%2C+0%2C+1%29&ms_1_clr7=rgba%28103%2C+58%2C+183%2C+1%29&ms_1_clr9=rgba%28190%2C+30%2C+45%2C+1%29&ms_sincedate=12-09-2025&ms_only_show_complete=true&ms_is_show_limit_milestone=false&ms_collapse_future_milestone=true&ms_show_total_limit_milestone=3&ms_collapse_complete_milestone=true&key=trstream-9QWbcPd1n8JhpZo9E1BV&mod=3&hash=b9073almo9r5ekzg&timestamp=1757688304'
        title='Project Web GoRakuDo'
        width='100%'
        maxWidth='312px'
        maxHeight='400px'
        className='mt-4'
      />
      <Content />
    </div>
  </article>
</PostLayout>

<script is:inline define:vars={{ postData }}>
  function sharePost() {
    const shareUrl = postData?.resolvedPath
      ? `${window.location.origin}${postData.resolvedPath}`
      : window.location.href;

    if (navigator.share) {
      navigator.share({
        title: postData?.title || 'Dukung Kami - GoRakuDo',
        text:
          postData?.description ||
          'Dukung pengembangan GoRakuDo dan komunitas open-source ini',
        url: shareUrl,
      });
    } else {
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('Link berhasil disalin ke clipboard!');
      });
    }
  }

  window.sharePost = sharePost;
</script>
