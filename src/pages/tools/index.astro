---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ToolsGridSection from '../../components/tools/Tools-GridSection.astro';

// Breadcrumb Schema
import { generateBreadcrumbSchema } from '../../utils/breadcrumb-schema';

// Import CSS
import '../../styles/pages/tools/tools-index.css';

// Import data
import toolsData from '../../data/tools.json';
import toolsSeoData from './_tools-seo.json';

// ========== TYPE DEFINITIONS ==========
interface Tool {
  readonly id: string;
  readonly name: string;
  readonly description: string;
  readonly iconUrl: string;
  readonly color?: string;
  readonly link: string;
}

// Tools data - JSONファイルから読み込み
const tools: Tool[] = toolsData as Tool[];

// ========== TOOLS HEADER CONSTANTS & CONFIGURATION ==========
const STATS_CONFIG = {
  tools: {
    label: 'Tools Terpilih',
    suffix: '+',
  },
  free: {
    label: 'Gratis',
    value: '100%',
  },
  access: {
    label: 'Akses',
    value: '24/7',
  },
} as const;

const TITLE_CONFIG = {
  main: 'Tools & Aplikasi',
  accent: 'Pembelajaran Bahasa Jepang',
} as const;

const DESCRIPTION =
  'Pilih tool yang sesuai dengan tahap pembelajaran dan kebutuhan Anda. Setiap tool telah dipilih berdasarkan efektivitas dan kemudahan penggunaan.';

// ========== UTILITY FUNCTIONS ==========
const getToolsCount = (tools: Tool[]): number => tools.length;

const getStatsData = (toolsCount: number) => [
  {
    number: `${toolsCount}${STATS_CONFIG.tools.suffix}`,
    label: STATS_CONFIG.tools.label,
  },
  {
    number: STATS_CONFIG.free.value,
    label: STATS_CONFIG.free.label,
  },
  {
    number: STATS_CONFIG.access.value,
    label: STATS_CONFIG.access.label,
  },
];

// ========== OPTIMIZED DATA PROCESSING ==========
// メイン処理 - 一度だけ計算
const toolsCount = getToolsCount(tools);
const statsData = getStatsData(toolsCount);

// SEO data - JSONファイルから読み込み
const seoData = toolsSeoData.seoData;

// Tools page用のBreadcrumb Schema生成
const breadcrumbSchema = generateBreadcrumbSchema({
  items: toolsSeoData.breadcrumbData.items.map(item => ({
    title: item.title,
    url: item.url,
    isActive: item.isActive,
  })),
  siteUrl: String(Astro.site || 'https://gorakudo.org'),
});

// FAQ Schema生成
const faqSchema = {
  '@context': 'https://schema.org' as const,
  '@type': 'FAQPage' as const,
  mainEntity: toolsSeoData.structuredData.faq.mainEntity.map(faq => ({
    '@type': 'Question' as const,
    name: faq.name,
    acceptedAnswer: {
      '@type': 'Answer' as const,
      text: faq.acceptedAnswer.text,
    },
  })),
} as const;
---

<BaseLayout
  title={seoData.title}
  description={seoData.description}
  keywords={seoData.keywords}
  pageType={seoData.pageType as 'article' | 'website'}
  lang='id'
  breadcrumbSchema={breadcrumbSchema}
  faqSchema={faqSchema}
>
  <!-- 2025 SEO Optimization: Technical SEO -->
  <link rel='canonical' href={`${Astro.site}/tools`} />
  <meta
    name='robots'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />
  <meta
    name='googlebot'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />
  <meta
    name='bingbot'
    content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'
  />

  <!-- Performance Optimization -->
  <link rel='preconnect' href='https://fonts.googleapis.com' />
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />
  <link rel='dns-prefetch' href='//github.com' />

  <!-- Critical Resource Preloading -->
  <link
    rel='preload'
    href='/icon/anki-icon-240.webp'
    as='image'
    type='image/webp'
  />
  <link
    rel='preload'
    href='/icon/yomitan-icon-240.webp'
    as='image'
    type='image/webp'
  />
  <link
    rel='preload'
    href='/icon/migaku-icon-240.webp'
    as='image'
    type='image/webp'
  />

  <!-- Astro Native Resource Preloading -->
  <link rel='prefetch' href='/tools/anki' fetchpriority='low' />
  <link rel='prefetch' href='/tools/yomitan' fetchpriority='low' />
  <link rel='prefetch' href='/tools/migaku' fetchpriority='low' />

  <!-- Security Headers -->
  <meta http-equiv='X-Content-Type-Options' content='nosniff' />
  <meta http-equiv='X-XSS-Protection' content='1; mode=block' />

  <!-- Structured Data: CollectionPage -->
  <script
    type='application/ld+json'
    set:html={JSON.stringify(toolsSeoData.structuredData.collectionPage)}
  />
  <!-- Main Content -->
  <main
    class='main-content min-h-screen tools-layout-optimized'
    role='main'
    transition:name='main-content'
    aria-label='Japanese learning tools and applications'
  >
    <!-- Tools Header Section -->
    <section
      class='tools-header-section'
      aria-labelledby='tools-header-title'
      role='banner'
      transition:name='tools-header'
      itemscope
      itemtype='https://schema.org/WebPageElement'
    >
      <div class='tools-header-container'>
        <!-- Main Content -->
        <div class='tools-header-content'>
          <header class='tools-header-main'>
            <h2
              class='tools-header-title'
              id='tools-header-title'
              itemprop='headline'
            >
              <span class='tools-title-main'>{TITLE_CONFIG.main}</span>
              <span class='tools-title-accent'>{TITLE_CONFIG.accent}</span>
            </h2>

            <p class='tools-header-description' itemprop='description'>
              {DESCRIPTION}
            </p>
          </header>

          <!-- Stats Section -->
          <div
            class='tools-header-stats'
            role='region'
            aria-label='Tools statistics'
          >
            {
              statsData.map((stat, index) => (
                <>
                  <div
                    class='tools-stat-item'
                    itemprop='mainEntity'
                    itemscope
                    itemtype='https://schema.org/QuantitativeValue'
                  >
                    <span class='tools-stat-number' itemprop='value'>
                      {stat.number}
                    </span>
                    <span class='tools-stat-label' itemprop='name'>
                      {stat.label}
                    </span>
                  </div>
                  {index < statsData.length - 1 && (
                    <div class='tools-stat-divider' aria-hidden='true' />
                  )}
                </>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Tools Grid Section - 統合されたコンポーネント -->
    <ToolsGridSection tools={tools} />
  </main>
</BaseLayout>

<script>
  // ========== ASTRO NATIVE APPROACH (Minimal JavaScript) ==========
  // Performance-optimized with CSS-first approach

  // Minimal loading state management (CSS handles most animations)
  document.addEventListener('DOMContentLoaded', function () {
    // Apply page load animations with performance monitoring
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      mainContent.classList.add('page-load-fade-in');
    }

    // Apply staggered animations to tool cards using CSS custom properties
    const toolCards = document.querySelectorAll('.tool-card');
    toolCards.forEach((card, index) => {
      (card as HTMLElement).style.setProperty(
        '--stagger-delay',
        `${index * 0.1}s`
      );
      card.classList.add('stagger-animation');
    });

    console.log('✅ Astro native loading states applied');
  });

  // Enhanced micro-interactions for better feedback
  document.addEventListener('DOMContentLoaded', function () {
    // Add micro-interactions ONLY to tools page elements (avoid navbar conflicts)
    const toolsPageElements = document.querySelectorAll(`
      .tool-card,
      .tools-section a,
      .tools-section button,
      .main-content a:not([href="/"]),
      .main-content button:not(.get-started-btn):not(.mobile-menu-btn)
    `);
    toolsPageElements.forEach(element => {
      element.classList.add('micro-interaction-scale');
    });

    // Tool card interactions simplified (keyboard navigation removed)

    console.log(
      '✅ Astro native micro-interactions and scroll reveals initialized'
    );
  });

  // REDESIGNED tool card interaction system
  document.addEventListener('DOMContentLoaded', () => {
    const toolCards = document.querySelectorAll('.tool-card');

    toolCards.forEach(card => {
      // Click/Tap feedback for all devices
      card.addEventListener('click', e => {
        e.preventDefault();

        // Add visual feedback
        card.classList.add('is-interacting');

        // Navigate after animation
        setTimeout(() => {
          card.classList.remove('is-interacting');
          window.location.href = (card as HTMLAnchorElement).href;
        }, 150);
      });

      // Click interaction only (keyboard navigation removed)
    });
  });

  // ========== TOOLS HEADER STATS ANIMATION ==========
  // パフォーマンス最適化: 統計アニメーション
  function optimizeStatsAnimation() {
    const statsItems = document.querySelectorAll(
      '.tools-stat-item'
    ) as NodeListOf<HTMLElement>;

    if ('IntersectionObserver' in window) {
      const statsObserver = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const element = entry.target as HTMLElement;
              element.style.opacity = '1';
              element.style.transform = 'translateY(0)';
              statsObserver.unobserve(entry.target);
            }
          });
        },
        {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px',
        }
      );

      statsItems.forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        item.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        statsObserver.observe(item);
      });
    }
  }

  // DOM読み込み完了後に実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', optimizeStatsAnimation);
  } else {
    optimizeStatsAnimation();
  }

  // ========== 2025 SEO OPTIMIZATION: PERFORMANCE MONITORING ==========
  // Core Web Vitals monitoring (simplified for 2025)
  function monitorCoreWebVitals() {
    // Basic performance monitoring without external dependencies
    if ('performance' in window && 'PerformanceObserver' in window) {
      try {
        const observer = new PerformanceObserver(list => {
          list.getEntries().forEach(entry => {
            if (entry.entryType === 'largest-contentful-paint') {
              console.log('LCP:', entry.startTime);
            } else if (entry.entryType === 'first-input') {
              const fidEntry = entry as any;
              console.log('FID:', fidEntry.processingStart - entry.startTime);
            } else if (entry.entryType === 'layout-shift') {
              const clsEntry = entry as any;
              console.log('CLS:', clsEntry.value);
            }
          });
        });

        observer.observe({
          entryTypes: [
            'largest-contentful-paint',
            'first-input',
            'layout-shift',
          ],
        });
      } catch (error) {
        console.log('Performance monitoring not available:', error);
      }
    }
  }

  // Intersection Observer for lazy loading optimization
  function optimizeLazyLoading() {
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver(
        (entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target as HTMLImageElement;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
              }
            }
          });
        },
        {
          rootMargin: '50px 0px',
          threshold: 0.01,
        }
      );

      document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
      });
    }
  }

  // Service Worker registration for caching
  function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js', {
            scope: '/',
            updateViaCache: 'none',
          })
          .then(registration => {
            console.log('SW registered: ', registration);

            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (
                    newWorker.state === 'installed' &&
                    navigator.serviceWorker.controller
                  ) {
                    // New content available, notify user
                    if (confirm('New version available! Reload to update?')) {
                      window.location.reload();
                    }
                  }
                });
              }
            });
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  }

  // Initialize all optimizations
  document.addEventListener('DOMContentLoaded', () => {
    monitorCoreWebVitals();
    optimizeLazyLoading();
    registerServiceWorker();
  });
</script>
