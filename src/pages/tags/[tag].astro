---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ContentCard from '../../components/content/tagCategories-cards.astro';

// 静的パス生成 - 全タグのページを自動生成
export async function getStaticPaths() {
  const [docs, toolArticles] = await Promise.all([
    getCollection('docs'),
    getCollection('tool-articles'),
  ]);

  // 全コンテンツからユニークなタグを抽出
  const allTags = new Set<string>();

  // docsコレクションからタグを抽出
  docs.forEach(post => {
    const tags = post.data.tags || [];
    tags.forEach(tag => allTags.add(tag));
  });

  // tool-articlesコレクションからタグを抽出
  toolArticles.forEach(post => {
    const tags = post.data.tags || [];
    tags.forEach(tag => allTags.add(tag));
  });

  // 各タグのページを生成
  return Array.from(allTags).map(tag => {
    const slug = tag.toLowerCase().replace(/ /g, '-');
    return {
      params: { tag: slug },
      props: { originalTag: tag },
    };
  });
}

const { tag } = Astro.params;
const { originalTag } = Astro.props;

// 現在のタグに該当するコンテンツをフィルタリング
const [docs, toolArticles] = await Promise.all([
  getCollection('docs'),
  getCollection('tool-articles'),
]);

const allContent = [...docs, ...toolArticles];
const taggedContent = allContent.filter(post => {
  const tags = post.data.tags || [];
  return tags.some(
    t => t.toLowerCase().replace(/ /g, '-') === tag.toLowerCase()
  );
});

// コンテンツを日付順でソート
const sortedContent = taggedContent.sort(
  (a, b) =>
    new Date(b.data.publishedDate).getTime() -
    new Date(a.data.publishedDate).getTime()
);

// SEO用のメタデータ
const seoData = {
  title: `Posts tagged with: ${originalTag} - GoRakuDo`,
  description: `Browse all posts tagged with ${originalTag} on GoRakuDo. Find articles, guides, and resources related to ${originalTag}.`,
  keywords: [originalTag, 'japanese learning', 'immersion', 'tags'],
};
---

<BaseLayout
  title={seoData.title}
  description={seoData.description}
  keywords={seoData.keywords}
  pageType='website'
  lang='id'
>
  <main class='container mx-auto px-4 py-8'>
    <!-- ページヘッダー -->
    <header class='mb-8'>
      <nav class='mb-4'>
        <a
          href='/tags'
          class='text-blue-600 hover:text-blue-800 flex items-center gap-2'
        >
          <svg
            class='w-4 h-4'
            fill='none'
            stroke='currentColor'
            viewBox='0 0 24 24'
          >
            <path
              stroke-linecap='round'
              stroke-linejoin='round'
              stroke-width='2'
              d='M19 12H5m7-7l-7 7 7 7'></path>
          </svg>
          Back to All Tags
        </a>
      </nav>

      <h1 class='text-3xl font-bold mb-2'>
        Posts tagged with: #{originalTag}
      </h1>
      <p class='text-gray-600'>
        Found {sortedContent.length} post{sortedContent.length !== 1 ? 's' : ''}
        tagged with "{originalTag}"
      </p>
    </header>

    <!-- コンテンツ一覧 -->
    {
      sortedContent.length > 0 ? (
        <div class='grid gap-6 md:grid-cols-2 lg:grid-cols-3'>
          {sortedContent.map(post => {
            const categories = post.data.categories || [];
            const tags = post.data.tags || [];
            return (
              <ContentCard
                title={post.data.title}
                description={post.data.description}
                slug={post.slug}
                publishedDate={post.data.publishedDate}
                author={post.data.author}
                category={categories[0] || 'general'}
                tags={tags}
              />
            );
          })}
        </div>
      ) : (
        <div class='text-center py-12'>
          <div class='mb-4'>
            <svg
              class='w-16 h-16 mx-auto text-gray-400'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path
                stroke-linecap='round'
                stroke-linejoin='round'
                stroke-width='2'
                d='M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.709M15 6.291A7.962 7.962 0 0012 5c-2.34 0-4.29 1.009-5.824 2.709'
              />
            </svg>
          </div>
          <p class='text-gray-500 mb-4'>No posts found for this tag.</p>
          <a
            href='/tags'
            class='text-blue-600 hover:text-blue-800 inline-flex items-center gap-2'
          >
            <svg
              class='w-4 h-4'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path
                stroke-linecap='round'
                stroke-linejoin='round'
                stroke-width='2'
                d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'
              />
            </svg>
            Browse all tags
          </a>
        </div>
      )
    }
  </main>
</BaseLayout>
