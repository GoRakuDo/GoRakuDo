---
// ========== IMPORTS ==========
import { getEntry } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';
import Breadcrumb from '../../components/common/Breadcrumb.astro';
import { resolvePath, getCollectionInfo } from '../../utils/collections';
import { generateBreadcrumbSchema } from '../../utils/breadcrumb-schema';
import aboutUsSeoConfig from '../../data/seo/pages/about-us.json';

// ========== CONTENT LOADING ==========
const post = await getEntry('pages', 'about-us');

if (!post) return Astro.redirect('/pages?error=post-not-found');
if (post.data.status !== 'published') return Astro.redirect('/404');

// ========== CONTENT PROCESSING ==========
const { Content, headings } = await post.render();
const tocHeadings = headings.filter(
  (heading: { depth: number }) => heading.depth >= 2 && heading.depth <= 3
);
const resolvedPath = { path: resolvePath('pages', post.slug) };
const collectionMetadata = getCollectionInfo('pages');

// ========== SEO DATA FROM JSON ==========
const seoData = {
  ...aboutUsSeoConfig.seoData,
  modifiedDate: aboutUsSeoConfig.seoData.publishedDate,
  lang: aboutUsSeoConfig.seoData.lang as 'id' | 'ja',
};

// ========== CLIENT DATA ==========
const postData = {
  title: post.data.title,
  description: post.data.description,
  resolvedPath: resolvedPath.path,
};

// ========== BREADCRUMB CONFIGURATION FROM JSON ==========
const breadcrumbConfig = {
  currentPath: resolvedPath.path,
  showHome: true,
  showIcons: true,
  ariaLabel: 'About us page navigation breadcrumb',
};

const breadcrumbSchema = generateBreadcrumbSchema({
  items: aboutUsSeoConfig.breadcrumbData.items.map((item: any) => ({
    title: item.name,
    url: item.url,
    isActive: item.isActive,
  })),
  siteUrl: String(Astro.site || 'https://gorakudo.org'),
});
---

<PostLayout
  title={seoData.title}
  description={seoData.description}
  publishedDate={seoData.publishedDate}
  lang={seoData.lang}
  author={seoData.author}
  tags={seoData.keywords}
  post={post}
  collectionMetadata={collectionMetadata}
  headings={tocHeadings}
  postActions={false}
  breadcrumbConfig={breadcrumbConfig}
  breadcrumbSchema={breadcrumbSchema}
  faqSchema={aboutUsSeoConfig.faqSchema}
>
  <!-- Breadcrumb Slot -->
  <Breadcrumb
    slot='breadcrumb'
    {post}
    currentPath={breadcrumbConfig.currentPath}
    showHome={breadcrumbConfig.showHome}
    showIcons={breadcrumbConfig.showIcons}
    ariaLabel={breadcrumbConfig.ariaLabel}
  />

  <!-- Header Slot -->
  <header slot='header' class='content-header mt-8'>
    <h1>{post.data.title}</h1>

    {
      (post.data.publishedDate || post.data.author) && (
        <div class='content-meta' aria-label='Post metadata'>
          <time class='content-date' datetime={seoData.publishedDate}>
            {new Date(seoData.publishedDate).toLocaleDateString('id-ID', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}
          </time>
          <span class='content-author'>
            by {post.data.author || 'Tim GoRakuDo'}
          </span>
        </div>
      )
    }

    {
      post.data.tags && post.data.tags.length > 0 ? (
        <nav
          class='flex gap-2 flex-wrap mt-4 justify-center sm:justify-start'
          aria-label='Article tags'
        >
          {post.data.tags.map((tag: string) => (
            <span class='bg-primary/20 text-primary px-2 py-1 rounded text-xs border border-primary/30'>
              {tag}
            </span>
          ))}
        </nav>
      ) : (
        <div class='tag-warning mt-4' role='alert'>
          <span class='text-warning text-sm'>
            Belum ada tag yang ditetapkan
          </span>
        </div>
      )
    }
  </header>

  <!-- Content Slot -->
  <div slot='content'>
    <div class='about-content'>
      <Content />
    </div>
  </div>
</PostLayout>

<!-- ========== SCRIPTS ========== -->
<script is:inline define:vars={{ postData }}>
  const sharePost = () => {
    const shareUrl = postData?.resolvedPath
      ? `${window.location.origin}${postData.resolvedPath}`
      : window.location.href;

    if (navigator.share) {
      navigator.share({
        title: postData?.title || 'Tentang Kami - GoRakuDo',
        text:
          postData?.description ||
          'Kenali perjalanan GoRakuDo dan komunitas pembelajar bahasa Jepang terbesar di Indonesia',
        url: shareUrl,
      });
    } else {
      navigator.clipboard.writeText(shareUrl).then(() => {
        alert('Link berhasil disalin ke clipboard!');
      });
    }
  };

  window.sharePost = sharePost;
</script>
